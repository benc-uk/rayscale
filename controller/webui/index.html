<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="favicon.png" type="image/png">

  <script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Questrial" rel="stylesheet">
  <!--link href="/ui/jsoneditor/jsoneditor.css" rel="stylesheet" type="text/css"-->
  <!--script src="/ui/jsoneditor/jsoneditor.js"></script-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/theme-tomorrow_night.js"></script>

  <title>RayScale: Web UI</title>

  <link rel="stylesheet" href="css/app.css">
  <link rel="icon" href="favicon.png">
</head>

<body>

  <h1><i class="fa fa-eye"></i> RayScale - Distributed Ray Tracer</h1>

  <!--h2><i class="fa fa-code"></i> Job Input</h2-->
  <!-- editor -->
  <div id="editor" wrap="soft" name="editor"></div><br/>
  <button onclick="jobSubmitter()" class="button">Start Job</button>
  <button onclick="jobRefresh()" class="button">Refresh Jobs</button> &nbsp; 
  <div id="resp">-</div>

  <br/><br/>

  <!--h2><i class="fa fa-cubes"></i> Completed Jobs</h2-->
  <!-- job table -->
  <table class="jobs">
    <thead class="jobs">
      <tr><th>Job Name</th><th>Render</th><th>Result Data</th><th>Scene JSON</th></tr>
    </thead>
    <tbody id="jobList"></tbody>
  </table>
  <br/>

  <!-- ######################################################################### -->

  <script>

  //
  //
  //
  function jobSubmitter() {
    let job = editor.getValue();
    window.localStorage.setItem('rayScaleJob', job);
    fetch("/api/jobs",
    {
        headers: { 'Accept': 'application/json', 'Content-Type': 'application/x-yaml' },
        method: "POST",
        body: job
    })
    .then(res => { 
      res.json().then(j => { document.getElementById('resp').innerHTML = JSON.stringify(j) });
     })
    .catch(err => {
      err.json().then(j => { document.getElementById('resp').innerHTML = "err "+JSON.stringify(j)  });
    })
  }

  //
  //
  //
  function jobRefresh() {
    let table = document.getElementById('jobList');
    table.innerHTML = "";
    fetch("/api/jobs",
    {
        headers: {'Accept': 'application/json'},
        method: "GET",
    })
    .then(res => { 
      res.json().then(data => {
        for(let job of data.jobs) {
          let row = table.insertRow(0);
          var cell1 = row.insertCell(0);
          cell1.innerHTML = `<b>${job}</b>&nbsp;&nbsp;&nbsp;`;
          var cell2 = row.insertCell(1);
          let r = Math.random();
          cell2.innerHTML = `<a href='/jobs/${job}/render.png' target='${job}_render'><img src='/jobs/${job}/render.png?r=${r}' width='200px'></a>`;
          var cell3 = row.insertCell(2);
          cell3.innerHTML = `<a href='/jobs/${job}/result.json' target='${job}_result'>Results (JSON)</a>`;
          var cell4 = row.insertCell(3);
          cell4.innerHTML = `<a href='/jobs/${job}/scene.json' target='${job}_scene'>Scene (JSON)</a>`;
        }
      });
     })
    .catch(err => {
      err.json().then(j => {document.getElementById('resp').value=("err "+JSON.stringify(j))});
    })
  }

  //
  // On page load
  //
  jobRefresh();

  // pass options to ace.edit
  var editor = ace.edit(document.getElementById('editor'), {
      mode: "ace/mode/yaml",
      selectionStyle: "text",
      theme: "ace/theme/tomorrow_night",
      fontSize: "19px"
  })

  let job = window.localStorage.getItem('rayScaleJob');
  editor.setValue(job)

  </script>
</body>

</html>
